<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Interactive Pro - VR Ind√©pendante</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

  <style>
    /* √âcran d'accueil pour forcer l'interaction utilisateur (d√©bloque l'audio) */
    #overlay {
      position: absolute; z-index: 999; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
      flex-direction: column; color: white; font-family: sans-serif;
    }
    #startBtn {
      padding: 15px 30px; font-size: 18px; background: #1565C0; color: white;
      border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;
    }
    
    /* Ajout d'un overlay sp√©cifique pour le mode VR ind√©pendant */
    #vrModeOverlay {
      position: absolute; z-index: 998; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: white; padding: 10px;
      border-radius: 5px; display: none; font-size: 12px;
    }
    
    /* Style pour les boutons de contr√¥le VR */
    .vr-control-btn {
      position: absolute; z-index: 997; background: rgba(0,0,0,0.7);
      color: white; border: 2px solid #1565C0; border-radius: 50%;
      width: 60px; height: 60px; display: none; justify-content: center;
      align-items: center; font-size: 24px; cursor: pointer;
    }
  </style>
</head>

<body style="margin:0; overflow:hidden;">

  <div id="overlay">
    <h2>Exp√©rience AR/VR</h2>
    <p>Scannez le marqueur Hiro pour activer la VR ind√©pendante</p>
    <button id="startBtn">COMMENCER L'EXP√âRIENCE</button>
  </div>

  <!-- Overlay pour indiquer le mode VR ind√©pendant -->
  <div id="vrModeOverlay">
    üöÄ VR IND√âPENDANTE ACTIV√âE<br>Le contenu est maintenant autonome
  </div>

  <!-- Boutons de contr√¥le pour la VR ind√©pendante -->
  <button id="resetVRBtn" class="vr-control-btn" style="top: 80px; left: 10px;">‚Üª</button>
  <button id="vrEffectsBtn" class="vr-control-btn" style="top: 150px; left: 10px;">‚ú®</button>

  <a-scene 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;"
    gesture-detector
    id="scene">

    <a-assets>
      <img id="civ" src="civ.png">
      <img id="cv" src="CVDanielHoba.jpg">
      <img id="imgA1" src="A1.jpg">
      <img id="imgA2" src="A2.jpg">
      <img id="imgA3" src="A3.png"> 
      <img id="imgA4" src="A4.jpg">
      
      <video id="videoCR" src="cr.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
      <video id="videoBR" src="br.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
      
      <!-- Textures pour effets VR -->
      <img id="gridTexture" src="https://cdn.aframe.io/a-painter/images/grid.png" crossorigin="anonymous">
    </a-assets>

    <!-- MARQUEUR HIRO √Ä LA RACINE -->
    <a-marker preset="hiro" id="marker" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" markerhandler>
      <!-- Feedback visuel minimal pour le marqueur -->
      <a-ring color="#1565C0" radius-inner="0.05" radius-outer="0.08" rotation="-90 0 0" 
              opacity="0.3" animation="property: scale; to: 1.2 1.2 1.2; dur: 1200; dir: alternate; loop: true"></a-ring>
    </a-marker>

    <!-- CONTENEUR VR IND√âPENDANT (cach√© initialement) -->
    <a-entity id="independentVRContainer" visible="false" position="0 0 -3" scale="0.01 0.01 0.01">
      <!-- Environnement VR (ciel et sol) -->
      <a-sky id="vrSky" color="#000011" visible="true"></a-sky>
      <a-circle id="vrGround" radius="10" rotation="-90 0 0" position="0 0 0" color="#111122" opacity="0.8" 
                material="src: #gridTexture; repeat: 20 20;"></a-circle>
      
      <!-- Contenu principal VR avec animations ind√©pendantes -->
      <a-entity id="vrContentGroup" position="0 0 0">
        <!-- Panneau gauche avec animations VR sp√©cifiques -->
        <a-entity id="vrLeftPanel" position="-1.5 0.8 0" 
                  animation__float="property: position; to: -1.5 1 0; dir: alternate; dur: 3000; easing: easeInOutSine; loop: true"
                  animation__rotate="property: rotation; to: 0 5 0; dir: alternate; dur: 4000; easing: easeInOutSine; loop: true">
          
          <a-video src="#videoCR" class="clickable video-control vr-element"
                   position="0 0 0" width="2" height="1.12"
                   animation__pulse="property: scale; to: 1.05 1.05 1.05; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; startEvents: mouseenter; pauseEvents: mouseleave">
          </a-video>
          
          <a-text value="VID√âO 1 - VR" position="0 -0.7 0" align="center" width="3" 
                  color="#1565C0" font="roboto"
                  animation__color="property: color; to: #4FC3F7; dir: alternate; dur: 2000; loop: true"></a-text>

          <a-entity position="-0.5 -1.2 0" 
                    animation__float2="property: position; to: -0.5 -1 0; dir: alternate; dur: 2500; delay: 500; loop: true">
            <a-image src="#imgA1" class="clickable vr-element" width="1" height="1"
                     animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 500; easing: easeOutElastic; startEvents: mouseenter"></a-image>
          </a-entity>
          
          <a-entity position="0.5 -1.2 0"
                    animation__float3="property: position; to: 0.5 -1 0; dir: alternate; dur: 2500; delay: 1000; loop: true">
            <a-image src="#imgA2" class="clickable vr-element" width="1" height="1"
                     animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 500; easing: easeOutElastic; startEvents: mouseenter"></a-image>
          </a-entity>
          
          <a-entity position="0 -1.8 0" rotation="0 180 0"
                    animation__float4="property: position; to: 0 -1.6 0; dir: alternate; dur: 3000; delay: 1500; loop: true">
            <a-plane src="#civ" class="clickable vr-element" width="1.5" height="1"
                     animation__rotate2="property: rotation; to: 0 360 0; dur: 10000; loop: true"></a-plane>
          </a-entity>
        </a-entity>

        <!-- Panneau droit avec animations VR sp√©cifiques -->
        <a-entity id="vrRightPanel" position="1.5 0.8 0"
                  animation__float="property: position; to: 1.5 1 0; dir: alternate; dur: 3000; delay: 1000; easing: easeInOutSine; loop: true"
                  animation__rotate="property: rotation; to: 0 -5 0; dir: alternate; dur: 4000; easing: easeInOutSine; loop: true">
          
          <a-video src="#videoBR" class="clickable video-control vr-element"
                   position="0 0 0" width="2" height="1.12"
                   animation__pulse="property: scale; to: 1.05 1.05 1.05; dir: alternate; dur: 2000; delay: 1000; easing: easeInOutSine; loop: true; startEvents: mouseenter; pauseEvents: mouseleave">
          </a-video>
          
          <a-text value="VID√âO 2 - VR" position="0 -0.7 0" align="center" width="3" 
                  color="#1565C0" font="roboto"
                  animation__color="property: color; to: #4FC3F7; dir: alternate; dur: 2000; delay: 1000; loop: true"></a-text>
          
          <a-entity position="-0.5 -1.2 0"
                    animation__float2="property: position; to: -0.5 -1 0; dir: alternate; dur: 2500; delay: 500; loop: true">
            <a-image src="#imgA3" class="clickable vr-element" width="1" height="1"
                     animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 500; easing: easeOutElastic; startEvents: mouseenter"></a-image>
          </a-entity>
          
          <a-entity position="0.5 -1.2 0"
                    animation__float3="property: position; to: 0.5 -1 0; dir: alternate; dur: 2500; delay: 1000; loop: true">
            <a-image src="#imgA4" class="clickable vr-element" width="1" height="1"
                     animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 500; easing: easeOutElastic; startEvents: mouseenter"></a-image>
          </a-entity>
          
          <a-entity position="0 -1.8 0" rotation="0 0 0"
                    animation__float4="property: position; to: 0 -1.6 0; dir: alternate; dur: 3000; delay: 1500; loop: true">
            <a-plane src="#cv" class="clickable vr-element" width="1.5" height="2"
                     animation__rotate2="property: rotation; to: 0 360 0; dur: 15000; loop: true; easing: linear"></a-plane>
          </a-entity>
        </a-entity>
        
        <!-- √âl√©ments d√©coratifs VR -->
        <a-entity id="vrStars">
          <!-- Particules/√©toiles pour effet spatial -->
          <a-entity geometry="primitive: sphere" material="color: #FFFFFF; shader: flat" scale="0.05 0.05 0.05" position="-3 2 -5"></a-entity>
          <a-entity geometry="primitive: sphere" material="color: #FFFFFF; shader: flat" scale="0.03 0.03 0.03" position="2 1.5 -4"></a-entity>
          <a-entity geometry="primitive: sphere" material="color: #4FC3F7; shader: flat" scale="0.04 0.04 0.04" position="-1 2.5 -3"></a-entity>
        </a-entity>
        
        <!-- Bouton de fermeture VR -->
        <a-entity id="vrCloseBtn" class="clickable vr-element" position="0 -2.5 0" visible="true">
          <a-circle radius="0.2" color="#FF5252"></a-circle>
          <a-text value="X" align="center" width="2" position="0 0 0.01" color="white"></a-text>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-entity camera>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable, .vr-element"></a-entity>
    </a-entity>

  </a-scene>

  <script>
    // 1. GESTION DE L'OVERLAY DE D√âMARRAGE
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const videos = document.querySelectorAll('video');
    const vrModeOverlay = document.getElementById('vrModeOverlay');
    const resetVRBtn = document.getElementById('resetVRBtn');
    const vrEffectsBtn = document.getElementById('vrEffectsBtn');
    
    // Variables pour la VR ind√©pendante
    let vrIndependentActive = false;
    const vrContainer = document.querySelector('#independentVRContainer');
    const vrContentGroup = document.querySelector('#vrContentGroup');
    const vrSky = document.querySelector('#vrSky');
    const vrGround = document.querySelector('#vrGround');
    const vrStars = document.querySelector('#vrStars');
    let vrEffectsEnabled = true;

    startBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      videos.forEach(v => {
        v.play().then(() => {
          v.pause();
        }).catch(e => console.log("Auto-play prevented", e));
      });
    });

    // 2. COMPOSANT POUR G√âRER LE MARQUEUR (ACTIVATION VR IND√âPENDANTE)
    AFRAME.registerComponent('markerhandler', {
      init: function () {
        const marker = this.el;
        let vrActivated = false;
        
        marker.addEventListener('markerFound', () => {
          console.log("Marqueur Hiro trouv√© - Activation VR ind√©pendante");
          
          // ACTIVER LA VR IND√âPENDANTE (une seule fois)
          if (!vrIndependentActive && !vrActivated) {
            vrActivated = true;
            vrIndependentActive = true;
            
            // Afficher les indicateurs et contr√¥les VR
            vrModeOverlay.style.display = 'block';
            resetVRBtn.style.display = 'flex';
            vrEffectsBtn.style.display = 'flex';
            
            // Positionner la VR devant l'utilisateur
            const camera = document.querySelector('[camera]').object3D;
            const cameraWorldPos = new THREE.Vector3();
            camera.getWorldPosition(cameraWorldPos);
            
            // Calculer la direction de la cam√©ra
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            
            // Positionner le contenu VR √† 3m devant la cam√©ra
            const vrPosition = new THREE.Vector3()
              .copy(cameraWorldPos)
              .add(cameraDirection.multiplyScalar(3));
            
            vrContainer.object3D.position.set(vrPosition.x, vrPosition.y, vrPosition.z);
            
            // Orientation : regarder vers la cam√©ra
            vrContainer.object3D.lookAt(cameraWorldPos);
            
            // Animation d'apparition spectaculaire
            vrContainer.setAttribute("visible", "true");
            vrContainer.setAttribute("animation__scale", {
              property: 'scale',
              to: '1 1 1',
              dur: 1500,
              easing: 'easeOutElastic'
            });
            
            vrContainer.setAttribute("animation__opacity", {
              property: 'material.opacity',
              from: 0,
              to: 1,
              dur: 1000,
              delay: 500
            });
            
            // D√©marrer les vid√©os automatiquement en VR
            setTimeout(() => {
              document.querySelector('#videoCR').play();
              document.querySelector('#videoBR').play();
            }, 1000);
            
            console.log("VR ind√©pendante activ√©e - Le contenu est maintenant autonome");
          }
        });

        marker.addEventListener('markerLost', () => {
          console.log("Marqueur Hiro perdu");
          
          // IMPORTANT: En mode VR ind√©pendant, on ne fait RIEN quand le marqueur est perdu
          // Le contenu VR reste actif et visible
          if (!vrIndependentActive) {
            // Seulement si la VR n'est pas active, on peut mettre en pause les vid√©os
            videos.forEach(v => v.pause());
          }
        });
      }
    });

    // 3. LOGIQUE CLICK VID√âO (PLAY/PAUSE) POUR LES √âL√âMENTS VR
    document.addEventListener('click', function (evt) {
      const target = evt.target;
      
      // V√©rifier si on a cliqu√© sur un √©l√©ment vid√©o VR
      if (target.classList && target.classList.contains('video-control')) {
        const videoId = target.getAttribute('src'); 
        const videoEl = document.querySelector(videoId);
        
        if (videoEl) {
          if (videoEl.paused) {
            videoEl.play();
          } else {
            videoEl.pause();
          }
        }
      }
    });

    // 4. BOUTON DE R√âINITIALISATION VR
    resetVRBtn.addEventListener('click', () => {
      if (vrIndependentActive) {
        // R√©initialiser la position VR devant la cam√©ra
        const camera = document.querySelector('[camera]').object3D;
        const cameraWorldPos = new THREE.Vector3();
        camera.getWorldPosition(cameraWorldPos);
        
        const cameraDirection = new THREE.Vector3();
        camera.getWorldDirection(cameraDirection);
        
        const vrPosition = new THREE.Vector3()
          .copy(cameraWorldPos)
          .add(cameraDirection.multiplyScalar(3));
        
        vrContainer.object3D.position.set(vrPosition.x, vrPosition.y, vrPosition.z);
        vrContainer.object3D.lookAt(cameraWorldPos);
        
        // Effet visuel de r√©initialisation
        vrContainer.setAttribute("animation__pulse", {
          property: 'scale',
          to: '1.1 1.1 1.1',
          dir: 'alternate',
          dur: 500,
          easing: 'easeOutElastic'
        });
        
        console.log("Position VR r√©initialis√©e");
      }
    });

    // 5. BOUTON D'EFFETS VR
    vrEffectsBtn.addEventListener('click', () => {
      if (vrIndependentActive) {
        vrEffectsEnabled = !vrEffectsEnabled;
        
        if (vrEffectsEnabled) {
          // Activer les effets
          vrSky.setAttribute("visible", "true");
          vrGround.setAttribute("visible", "true");
          vrStars.setAttribute("visible", "true");
          
          // Animation de transition
          vrSky.setAttribute("animation__color", {
            property: 'color',
            to: '#000033',
            dur: 1000,
            easing: 'easeInOutSine'
          });
          
          vrEffectsBtn.textContent = "‚ú®";
          vrEffectsBtn.style.borderColor = "#4FC3F7";
        } else {
          // D√©sactiver les effets
          vrSky.setAttribute("visible", "false");
          vrGround.setAttribute("visible", "false");
          vrStars.setAttribute("visible", "false");
          
          vrEffectsBtn.textContent = "üåå";
          vrEffectsBtn.style.borderColor = "#1565C0";
        }
      }
    });

    // 6. BOUTON DE FERMETURE VR (dans la sc√®ne)
    document.querySelector('#vrCloseBtn').addEventListener('click', function() {
      if (vrIndependentActive) {
        // Animation de disparition
        vrContainer.setAttribute("animation__scale", {
          property: 'scale',
          to: '0.01 0.01 0.01',
          dur: 800,
          easing: 'easeInBack'
        });
        
        vrContainer.setAttribute("animation__opacity", {
          property: 'material.opacity',
          to: 0,
          dur: 500
        });
        
        // Cacher apr√®s l'animation
        setTimeout(() => {
          vrContainer.setAttribute("visible", "false");
          vrIndependentActive = false;
          vrModeOverlay.style.display = 'none';
          resetVRBtn.style.display = 'none';
          vrEffectsBtn.style.display = 'none';
          
          // Mettre en pause les vid√©os
          videos.forEach(v => v.pause());
          
          console.log("VR ind√©pendante d√©sactiv√©e");
        }, 800);
      }
    });

    // 7. INTERACTIONS AVEC LA SOURIS POUR LES √âL√âMENTS VR
    document.querySelectorAll('.vr-element').forEach(element => {
      // Effet au survol
      element.addEventListener('mouseenter', function() {
        if (!this.hasAttribute('animation__hover')) {
          this.setAttribute("animation__hover", {
            property: 'scale',
            to: '1.05 1.05 1.05',
            dur: 300,
            easing: 'easeOutElastic'
          });
        }
      });
      
      element.addEventListener('mouseleave', function() {
        if (this.hasAttribute('animation__hover')) {
          this.setAttribute("animation__hover", {
            property: 'scale',
            to: '1 1 1',
            dur: 300,
            easing: 'easeOutElastic'
          });
        }
      });
    });

    // 8. ANIMATION CONTINUE POUR LE CONTENU VR
    function animateVRContent() {
      if (vrIndependentActive) {
        // Faire tourner lentement l'ensemble du contenu VR
        const rotation = vrContentGroup.getAttribute('rotation') || {x: 0, y: 0, z: 0};
        const newRotation = {
          x: rotation.x,
          y: rotation.y + 0.1,
          z: rotation.z
        };
        vrContentGroup.setAttribute('rotation', newRotation);
      }
      
      requestAnimationFrame(animateVRContent);
    }
    
    // D√©marrer l'animation
    animateVRContent();

    // 9. GESTION DES TOUCHES CLAVIER POUR LA VR
    document.addEventListener('keydown', (e) => {
      if (!vrIndependentActive) return;
      
      const vrPos = vrContainer.object3D.position;
      const moveSpeed = 0.2;
      const rotateSpeed = 5;
      
      switch(e.key) {
        case 'ArrowUp':
          vrContainer.object3D.position.set(vrPos.x, vrPos.y + moveSpeed, vrPos.z);
          break;
        case 'ArrowDown':
          vrContainer.object3D.position.set(vrPos.x, vrPos.y - moveSpeed, vrPos.z);
          break;
        case 'ArrowLeft':
          vrContainer.object3D.position.set(vrPos.x - moveSpeed, vrPos.y, vrPos.z);
          break;
        case 'ArrowRight':
          vrContainer.object3D.position.set(vrPos.x + moveSpeed, vrPos.y, vrPos.z);
          break;
        case '+':
          vrContainer.object3D.scale.multiplyScalar(1.1);
          break;
        case '-':
          vrContainer.object3D.scale.multiplyScalar(0.9);
          break;
        case 'r':
        case 'R':
          // Rotation manuelle
          const rot = vrContainer.object3D.rotation;
          vrContainer.object3D.rotation.set(rot.x, rot.y + rotateSpeed * Math.PI/180, rot.z);
          break;
      }
    });

    console.log("Syst√®me VR ind√©pendant charg√© - Scannez le marqueur Hiro pour activer");
  </script>
</body>
</html>
